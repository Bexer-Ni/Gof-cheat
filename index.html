<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shot Decision Assistant ‚Äî Pro</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;background:#0f172a;color:var(--text)}
  header{padding:20px 16px 10px;position:sticky;top:0;background:rgba(15,23,42,.85);backdrop-filter:blur(6px);border-bottom:1px solid #1f2937;z-index:10}
  h1{margin:0;font-size:20px} .small{font-size:12px;color:#cbd5e1}
  main{padding:16px;max-width:980px;margin:0 auto}
  .card{background:linear-gradient(180deg,#0b1020,#0d1323);border:1px solid #1f2937;border-radius:12px;padding:14px;box-shadow:0 8px 20px rgba(0,0,0,.25);margin:12px 0}
  h2{margin:0 0 8px;font-size:16px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media(max-width:820px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:640px){.grid{grid-template-columns:1fr}}
  label{display:block;font-size:13px;color:#cbd5e1;margin:8px 0 4px}
  select,input[type=number],input[type=text]{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:var(--text)}
  .row{display:flex;gap:10px} .row>*{flex:1}
  .divider{height:1px;background:#1f2937;margin:10px 0}
  button{cursor:pointer;border:1px solid #334155;background:#0b1220;color:var(--text);padding:10px 12px;border-radius:10px;font-weight:600}
  .primary{background:linear-gradient(180deg,#0891b2,#0284c7);border:none}
  .good{background:linear-gradient(180deg,#10b981,#059669);border:none}
  .bad{background:linear-gradient(180deg,#ef4444,#dc2626);border:none}
  .tag{font-size:11px;color:#94a3b8;display:inline-block;padding:2px 8px;border:1px solid #334155;border-radius:999px;margin-right:6px}
  .badge{background:#0b1220;border:1px solid #334155;font-size:11px;padding:4px 8px;border-radius:999px;display:inline-block;margin-left:6px}
  ul{margin:8px 0 0 18px}
  .output{font-size:14px;line-height:1.55}
  pre{white-space:pre-wrap}
</style>
</head>
<body>
  <header>
    <h1>Shot Decision Assistant ‚Ä¢ Pro (‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á)</h1>
    <p class="small">‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‚Üí ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‚Ä¢ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏≤‡∏Å Feedback</p>
  </header>
  <main>
    <div class="card">
      <h2>1) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏†‡∏≤‡∏û‡∏ä‡πá‡∏≠‡∏ï (Conditions)</h2>
      <div class="grid">
        <div><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ä‡πá‡∏≠‡∏ï</label><select id="shotType"><option value="approach">Approach</option><option value="layup">Layup</option><option value="recovery">Recovery / Punch</option><option value="tee">Tee Shot</option><option value="short">Short Game</option></select></div>
        <div><label>Lie</label><select id="lie"><option>‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå</option><option>‡∏£‡∏±‡∏ü‡∏ó‡πå (‡∏ö‡∏≤‡∏á)</option><option>‡∏£‡∏±‡∏ü‡∏ó‡πå (‡∏´‡∏ô‡∏≤)</option><option>‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô</option><option>‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå</option><option>‡∏ü‡∏£‡∏¥‡∏ô‡∏à‡πå/‡πÄ‡∏≠‡∏û‡∏û‡πÇ‡∏£‡∏ä</option><option>‡∏ó‡∏µ‡∏≠‡∏≠‡∏ü</option></select></div>
        <div><label>‡∏£‡∏∞‡∏¢‡∏∞‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤ (‡πÄ‡∏°‡∏ï‡∏£)</label><input id="dist" type="number" min="5" max="260" value="120" /></div>
        <div><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ô Y</label><select id="slopeY"><option value="flat">‡∏û‡∏∑‡πâ‡∏ô‡∏£‡∏≤‡∏ö</option><option value="up_lite">‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option><option value="up_big">‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å</option><option value="down_lite">‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option><option value="down_big">‡∏•‡∏á‡∏°‡∏≤‡∏Å</option></select></div>
        <div><label>‡∏•‡∏π‡∏Å‡∏™‡∏π‡∏á/‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤</label><select id="slopeX"><option value="level">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏ó‡πâ‡∏≤</option><option value="above_lite">‡∏•‡∏π‡∏Å‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option><option value="above_big">‡∏•‡∏π‡∏Å‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏Å</option><option value="below_lite">‡∏•‡∏π‡∏Å‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option><option value="below_big">‡∏•‡∏π‡∏Å‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏Å</option></select></div>
        <div><label>‡∏•‡∏°</label><select id="wind"><option value="calm">‡∏•‡∏°‡∏™‡∏á‡∏ö</option><option value="head_lite">‡∏•‡∏°‡∏ï‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option><option value="head_big">‡∏•‡∏°‡∏ï‡πâ‡∏≤‡∏ô‡πÅ‡∏£‡∏á</option><option value="tail_lite">‡∏•‡∏°‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option><option value="tail_big">‡∏•‡∏°‡∏ï‡∏≤‡∏°‡πÅ‡∏£‡∏á</option><option value="cross_l2r">‡∏Ç‡∏ß‡∏≤‡∏á ‡∏ã‡πâ‡∏≤‡∏¢‚Üí‡∏Ç‡∏ß‡∏≤</option><option value="cross_r2l">‡∏Ç‡∏ß‡∏≤‡∏á ‡∏Ç‡∏ß‡∏≤‚Üí‡∏ã‡πâ‡∏≤‡∏¢</option></select></div>
        <div><label>‡∏™‡∏†‡∏≤‡∏û‡∏•‡∏π‡∏Å</label><select id="ball"><option value="normal">‡∏õ‡∏Å‡∏ï‡∏¥</option><option value="sitting">‡∏•‡∏≠‡∏¢‡∏ö‡∏ô‡∏´‡∏ç‡πâ‡∏≤</option><option value="down">‡∏à‡∏°/‡∏ù‡∏±‡∏á</option></select></div>
        <div><label>‡∏û‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô</label><select id="turf"><option value="normal">‡∏õ‡∏Å‡∏ï‡∏¥</option><option value="firm">‡πÅ‡∏Ç‡πá‡∏á</option><option value="soft">‡∏ô‡∏∏‡πà‡∏°/‡∏ä‡∏∑‡πâ‡∏ô</option></select></div>
        <div><label>‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á</label><select id="obs"><option value="none">‡πÑ‡∏°‡πà‡∏°‡∏µ</option><option value="carry">‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á</option><option value="low">‡∏Ñ‡∏∏‡∏°‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ï‡πà‡∏≥</option><option value="high">‡∏ä‡∏¥‡∏û/‡∏¢‡∏Å‡∏™‡∏π‡∏á</option></select></div>
        <div><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô</label><select id="stance"><option value="stable">‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á</option><option value="unstable">‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á</option></select></div>
        <div><label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ò‡∏á</label><select id="pin"><option value="center">‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô</option><option value="front">‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏µ‡∏ô</option><option value="back">‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏µ‡∏ô</option><option value="left">‡∏ã‡πâ‡∏≤‡∏¢</option><option value="right">‡∏Ç‡∏ß‡∏≤</option></select></div>
        <div><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏£‡∏µ‡∏ô</label><select id="green"><option value="normal">‡∏õ‡∏Å‡∏ï‡∏¥</option><option value="slow">‡∏ä‡πâ‡∏≤/‡∏ô‡∏∏‡πà‡∏°</option><option value="fast">‡πÑ‡∏ß/‡πÅ‡∏Ç‡πá‡∏á</option></select></div>
        <div style="grid-column:1/-1"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input id="notes" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏•‡∏µ‡∏Å‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ã‡πâ‡∏≤‡∏¢ / ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏•‡∏¢‡∏ò‡∏á" /></div>
      </div>
      <div class="divider"></div>
      <div class="row"><button class="primary" onclick="recommend()">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏µ</button><button onclick="resetForm()">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button></div>
      <p class="small">‡πÄ‡∏≠‡∏ô‡∏à‡∏¥‡∏ô rule-based + ‡∏ï‡∏±‡∏ß‡πÅ‡∏Å‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á (‡πÑ‡∏°‡πâ/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡∏π‡∏Å/‡∏ß‡∏¥‡∏ñ‡∏µ) + ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢ "‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡πà‡∏≠‡∏ô"</p>
    </div>

    <div class="card">
      <h2>2) ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏µ (Summary) <span id="score" class="badge">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå: 0</span></h2>
      <div id="output" class="output">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏µ‚Äù</div>
      <div id="tags" style="margin-top:10px"></div>
      <div class="divider"></div>
      <div class="row"><button class="good" onclick="feedback(true)">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô üëç</button><button class="bad" onclick="feedback(false)">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ‡πÑ‡∏°‡πà‡∏î‡∏µ üëé</button></div>
      <p class="small">‡∏î‡∏π‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
    </div>

    <div class="card">
      <h2>3) ‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏µ ‚Äî Log</h2>
      <div class="grid">
        <div><label>‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏Å</label><select id="res_main"><option value="hit">‡πÇ‡∏î‡∏ô‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô</option><option value="short">‡∏™‡∏±‡πâ‡∏ô</option><option value="long">‡∏¢‡∏≤‡∏ß</option><option value="left">‡∏ã‡πâ‡∏≤‡∏¢</option><option value="right">‡∏Ç‡∏ß‡∏≤</option><option value="fat">Fat</option><option value="thin">Thin</option><option value="bunker">‡∏•‡∏á‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå</option></select></div>
        <div><label>‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏ö‡∏≠‡∏•</label><select id="ball_shape"><option value="straight">‡∏ï‡∏£‡∏á</option><option value="draw">Draw</option><option value="fade">Fade</option><option value="hook">Hook</option><option value="slice">Slice</option></select></div>
        <div><label>‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏¢‡∏∞ (‡∏°.)</label><input id="miss_m" type="number" value="0" /></div>
      </div>
      <div class="row" style="margin-top:10px"><button onclick="saveResult()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</button><div style="text-align:right"><span class="small" id="logCount">logs: 0</span></div></div>
    </div>

    <div class="card">
      <h2>4) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ & ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</h2>
      <div class="row"><button onclick="exportData()">Export ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button><button onclick="importData()">Import ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button><button onclick="clearData()">‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</button></div>
      <div class="divider"></div>
      <details><summary>‡∏î‡∏π‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•/‡∏Å‡∏é‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ</summary><pre id="why" class="small"></pre></details>
    </div>

    <div class="card">
      <h2>5) Diagnostics / Self‚ÄëTest</h2>
      <div class="row"><button onclick="runTests()">Run Self‚ÄëTest</button></div>
      <details style="margin-top:8px"><summary>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</summary><pre id="testout" class="small"></pre></details>
    </div>
  </main>

<script>
'use strict';
// ===== Storage helpers =====
const KEY="golf_weights_pro", LOG="golf_logs_pro";
function getWeights(){ try{return JSON.parse(localStorage.getItem(KEY))||{} }catch(e){ return {} } }
function setWeights(w){ localStorage.setItem(KEY, JSON.stringify(w)); }
function getLogs(){ try{return JSON.parse(localStorage.getItem(LOG))||[] }catch(e){ return [] } }
function setLogs(L){ localStorage.setItem(LOG, JSON.stringify(L)); }
function profScore(){ return Object.values(getWeights()).reduce((a,b)=>a+b,0); }

// ===== Rule base =====
const tokenText={
  // Club / distance
  club_standard:"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì",
  club_up_0_5:"+0.5 ‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô)",
  club_up_1:"+1 ‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô)",
  club_down_0_5:"-0.5 ‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÑ‡∏Å‡∏•)",
  club_down_1:"-1 ‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÑ‡∏Å‡∏•)",
  take_enough_carry:"‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏Ç‡πâ‡∏≤‡∏° + ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ 10%",
  full_commit:"‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏™‡∏õ‡∏µ‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå",

  // Setup
  ball_center:"‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡∏π‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏ó‡πâ‡∏≤",
  ball_center_back:"‡∏•‡∏π‡∏Å‡∏Ñ‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏ä‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô)",
  ball_forward:"‡∏•‡∏π‡∏Å‡∏Ñ‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢",
  ball_back:"‡∏•‡∏π‡∏Å‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ï‡πà‡∏≥",
  widen_stance:"‡∏¢‡∏∑‡∏ô‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏†‡∏≤‡∏û",
  weight_left:"‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ã‡πâ‡∏≤‡∏¢ 60‚Äì70% (‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô)",
  weight_uphill_foot:"‡∏ñ‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÑ‡∏õ‡πÄ‡∏ó‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤",
  weight_forward:"‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏´‡∏ô‡πâ‡∏≤ 60%",
  hands_forward:"‡∏°‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢",
  grip_down_0_5:"‡∏à‡∏±‡∏ö‡∏Å‡∏£‡∏¥‡∏õ‡∏•‡∏î ~0.5 ‡∏ô‡∏¥‡πâ‡∏ß",
  grip_down_1:"‡∏à‡∏±‡∏ö‡∏Å‡∏£‡∏¥‡∏õ‡∏•‡∏î ~1 ‡∏ô‡∏¥‡πâ‡∏ß",

  // Swing
  contact_ball_then_turf:"‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏î‡∏ô‡∏´‡∏ç‡πâ‡∏≤",
  normal_trajectory:"‡∏™‡∏ß‡∏¥‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥",
  steepen_slight:"‡∏•‡∏á‡πÑ‡∏°‡πâ‡∏ä‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢",
  steepen:"‡∏•‡∏á‡πÑ‡∏°‡πâ‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏∞‡∏•‡∏∏‡∏£‡∏±‡∏ü‡∏ó‡πå",
  more_steep:"‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏∏‡∏°‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î fat",
  shallow_angle:"‡∏ó‡∏≥‡∏°‡∏∏‡∏°‡∏ï‡∏∑‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏ß‡∏≤‡∏î‡∏•‡∏π‡∏Å",
  pick_ball:"‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° 'pick' ‡∏•‡∏π‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏£‡∏≤‡∏¢/‡∏û‡∏∑‡πâ‡∏ô‡πÅ‡∏Ç‡πá‡∏á",
  less_sand:"‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏£‡∏≤‡∏¢‡πÄ‡∏¢‡∏≠‡∏∞",
  splash_sand:"‡∏ü‡∏≤‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏•‡∏π‡∏Å 2‚Äì3 ‡∏ã‡∏°.",
  accelerate:"‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏£‡∏≤‡∏¢",
  swing_smooth:"‡∏™‡∏ß‡∏¥‡∏á‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏• ‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á",
  short_back_long_through:"‡πÅ‡∏ö‡πá‡∏Ñ‡∏™‡∏ß‡∏¥‡∏á‡∏™‡∏±‡πâ‡∏ô ‡∏•‡∏á‡∏¢‡∏≤‡∏ß",
  shorter_back:"‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÅ‡∏ö‡πá‡∏Ñ‡∏™‡∏ß‡∏¥‡∏á",
  commit_speed:"‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏™‡∏õ‡∏µ‡∏î‡∏ú‡πà‡∏≤‡∏ô‡∏ö‡∏≠‡∏•",
  flatter_plane:"‡πÄ‡∏û‡∏•‡∏ô‡πÅ‡∏ö‡∏ô‡∏•‡∏á (‡∏•‡∏π‡∏Å‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤)",
  steeper_plane:"‡πÄ‡∏û‡∏•‡∏ô‡∏ä‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô (‡∏•‡∏π‡∏Å‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤)",
  bend_knees:"‡∏á‡∏≠‡πÄ‡∏Ç‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°",
  bend_knees_more:"‡∏á‡∏≠‡πÄ‡∏Ç‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô",
  firm_grip_lite:"‡∏à‡∏±‡∏ö‡∏Å‡∏£‡∏¥‡∏ö‡πÅ‡∏ô‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢",
  firm_grip:"‡∏à‡∏±‡∏ö‡∏Å‡∏£‡∏¥‡∏ö‡πÅ‡∏ô‡πà‡∏ô",
  open_face:"‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏±‡∏ö",
  speed_pop:"‡πÄ‡∏£‡πà‡∏á‡∏™‡∏õ‡∏µ‡∏î‡∏¢‡∏Å‡∏™‡∏π‡∏á",
  hold_loft:"‡∏Ñ‡∏∏‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î",
  keep_spin_down:"‡∏Ñ‡∏∏‡∏°‡∏™‡∏õ‡∏¥‡∏ô‡∏ï‡πà‡∏≥",
  control_spin:"‡∏Ñ‡∏∏‡∏°‡∏™‡∏õ‡∏¥‡∏ô‡∏ï‡∏≠‡∏ô‡∏•‡∏°‡∏ï‡∏≤‡∏°",
  clip_ball:"clip ‡∏•‡∏π‡∏Å‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡πÅ‡∏Ç‡πá‡∏á",
  make_divot_en:"Make a divot (‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏¥‡∏°‡πÅ‡∏û‡∏Ñ)",
  sweep_feel:"‡∏Å‡∏ß‡∏≤‡∏î‡∏•‡∏π‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ç‡πâ‡∏≤‡∏™‡∏π‡∏á‡πÅ‡∏ö‡∏ö‡∏ô‡∏∏‡πà‡∏°",

  // Strategy / Aim / Trajectory
  start_against_wind:"‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≤‡∏ô‡∏•‡∏°",
  start_against_wind_l2r:"‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡πâ‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏•‡∏°‡∏û‡∏≤‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤",
  start_against_wind_r2l:"‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏ß‡∏≤ ‡πÉ‡∏´‡πâ‡∏•‡∏°‡∏û‡∏≤‡πÑ‡∏õ‡∏ã‡πâ‡∏≤‡∏¢",
  allow_drift:"‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏•‡∏°‡∏û‡∏≤‡∏Å‡∏•‡∏±‡∏ö",
  aim_left:"‡πÄ‡∏•‡πá‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢",
  aim_left_more:"‡πÄ‡∏•‡πá‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô",
  aim_right:"‡πÄ‡∏•‡πá‡∏á‡∏Ç‡∏ß‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢",
  aim_right_more:"‡πÄ‡∏•‡πá‡∏á‡∏Ç‡∏ß‡∏≤‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô",
  aim_balance:"‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏ï‡∏≤‡∏°‡∏•‡∏≤‡∏î",
  traj_low_1:"(‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ï‡πà‡∏≥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)",
  traj_low_2:"(‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ï‡πà‡∏≥‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)",
  traj_high_1:"(‡∏ß‡∏¥‡∏ñ‡∏µ‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)",
  traj_high_2:"(‡∏ß‡∏¥‡∏ñ‡∏µ‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)",
  land_before_flag:"‡πÉ‡∏´‡πâ‡∏ï‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ò‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢",
  land_soft:"‡∏ï‡∏Å‡∏ô‡∏∏‡πà‡∏°/‡∏™‡∏õ‡∏¥‡∏ô‡∏°‡∏≤‡∏Å",
  knockdown:"‡∏ä‡πá‡∏≠‡∏ï Knockdown (‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á/‡∏°‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤)",
  consider_putt_or_low_chip:"‡∏û‡∏±‡∏ï‡∏ï‡πå/‡∏ä‡∏¥‡∏û‡∏•‡∏π‡∏Å‡∏ï‡πà‡∏≥ ‡∏ñ‡πâ‡∏≤‡∏ó‡∏≤‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î",
  reduce_loft_hint:"‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏•‡∏≠‡∏ü‡∏ó‡πå‡∏°‡∏≤‡∏Å (‡∏£‡∏±‡∏ü‡∏ó‡πå‡∏´‡∏ô‡∏≤)",
  aim_center_bias:"‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á",
  tee_height_half:"‡∏ï‡∏±‡πâ‡∏á‡∏ó‡∏µ‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏±‡∏ß‡πÑ‡∏°‡πâ",
  launch_high:"‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏°‡∏∏‡∏°‡πÄ‡∏´‡∏¥‡∏ô‡∏î‡∏µ"
};

// ‡∏Å‡∏é‡∏´‡∏•‡∏±‡∏Å
const rules = [
  s=> s.lie==="‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå" && ["club_standard","contact_ball_then_turf","normal_trajectory"],
  s=> s.lie==="‡∏£‡∏±‡∏ü‡∏ó‡πå (‡∏ö‡∏≤‡∏á)" && ["club_up_0_5","steepen_slight","firm_grip_lite"],
  s=> s.lie==="‡∏£‡∏±‡∏ü‡∏ó‡πå (‡∏´‡∏ô‡∏≤)" && ["club_up_1","steepen","ball_center_back","reduce_loft_hint","firm_grip","commit_speed"],
  s=> s.lie==="‡∏ü‡∏£‡∏¥‡∏ô‡∏à‡πå/‡πÄ‡∏≠‡∏û‡∏û‡πÇ‡∏£‡∏ä" && ["consider_putt_or_low_chip","weight_forward","hands_forward","short_back_long_through"],
  s=> s.lie==="‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô" && ["open_face","ball_forward","weight_left","splash_sand","accelerate","traj_high_1"],
  s=> s.lie==="‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå" && ["ball_center","pick_ball","less_sand","club_up_1","swing_smooth"],
  s=> s.lie==="‡∏ó‡∏µ‡∏≠‡∏≠‡∏ü" && ["tee_height_half","launch_high","widen_stance","traj_high_1"],

  s=> s.shotType==="recovery" && ["traj_low_2","ball_back","knockdown","start_against_wind"],
  s=> s.shotType==="short" && ["weight_forward","hands_forward","short_back_long_through"],

  s=> s.slopeY==="up_lite" && ["club_up_0_5","aim_balance","weight_uphill_foot"],
  s=> s.slopeY==="up_big" && ["club_up_1","shorter_back","weight_uphill_foot"],
  s=> s.slopeY==="down_lite" && ["club_down_0_5","ball_forward","swing_smooth","traj_high_1"],
  s=> s.slopeY==="down_big" && ["club_down_1","ball_forward","hold_loft","traj_high_1"],

  s=> s.slopeX==="above_lite" && ["aim_right","grip_down_0_5","flatter_plane"],
  s=> s.slopeX==="above_big" && ["aim_right_more","grip_down_1","flatter_plane"],
  s=> s.slopeX==="below_lite" && ["aim_left","bend_knees","steeper_plane"],
  s=> s.slopeX==="below_big" && ["aim_left_more","bend_knees_more","steeper_plane"],

  s=> s.wind==="head_lite" && ["club_up_0_5","traj_low_1","swing_smooth"],
  s=> s.wind==="head_big" && ["club_up_1","keep_spin_down","ball_back","traj_low_2"],
  s=> s.wind==="tail_lite" && ["club_down_0_5","traj_high_1"],
  s=> s.wind==="tail_big" && ["club_down_1","control_spin","land_before_flag","traj_high_2"],
  s=> s.wind==="cross_l2r" && ["start_against_wind_l2r","allow_drift"],
  s=> s.wind==="cross_r2l" && ["start_against_wind_r2l","allow_drift"],

  s=> s.ball==="sitting" && ["ball_forward","shallow_angle","sweep_feel","traj_high_1"],
  s=> s.ball==="down" && ["steepen","hands_forward","commit_speed","ball_back","traj_low_1"],

  s=> s.turf==="firm" && ["ball_center","shallow_angle","clip_ball"],
  s=> s.turf==="soft" && ["ball_back","more_steep","make_divot_en"],

  s=> s.obs==="carry" && ["take_enough_carry","full_commit"],
  s=> s.obs==="low" && ["knockdown","ball_back","hold_loft","traj_low_2"],
  s=> s.obs==="high" && ["open_face","speed_pop","land_soft","traj_high_2"],

  s=> s.stance==="unstable" && ["shorter_back","widen_stance","club_up_0_5"],

  s=> s.green==="fast" && ["land_before_flag","traj_high_1"],
  s=> s.green==="slow" && ["aim_center_bias","traj_low_1"],

  s=> (s.pin==="left"||s.pin==="right") && ["aim_center_bias"],

  // ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏°
  s=> (s.dist<=40 && s.lie!=="‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå") && ["short_back_long_through","weight_forward","hands_forward"],
  s=> (s.dist>=170 && s.lie!=="‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô") && ["swing_smooth"]
];

function getState(){
  return {
    shotType:document.getElementById('shotType').value,
    lie:document.getElementById('lie').value,
    dist:+document.getElementById('dist').value,
    slopeY:document.getElementById('slopeY').value,
    slopeX:document.getElementById('slopeX').value,
    wind:document.getElementById('wind').value,
    ball:document.getElementById('ball').value,
    turf:document.getElementById('turf').value,
    obs:document.getElementById('obs').value,
    stance:document.getElementById('stance').value,
    pin:document.getElementById('pin').value,
    green:document.getElementById('green').value,
    notes:document.getElementById('notes').value.trim(),
    time:new Date().toISOString()
  };
}

function gatherTokens(state){
  // ‡πÄ‡∏Å‡πá‡∏ö‡πÇ‡∏ó‡πÄ‡∏Ñ‡∏ô‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏ã‡πâ‡∏≥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î‡πÑ‡∏°‡πâ‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ (‡πÄ‡∏ä‡πà‡∏ô head_big + up_big)
  let t=[]; let why=[];
  for(const fn of rules){ const add = fn(state); if(Array.isArray(add)){ t = t.concat(add); why.push(add); } }
  return { tokens: t, why };
}

// ‡πÅ‡∏Å‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á: clubAdj / ball position / trajectory
function resolveTokens(tokens){
  let clubAdj=0; // + up, - down
  for(const k of tokens){
    if(k==="club_up_0_5") clubAdj+=0.5;
    if(k==="club_up_1") clubAdj+=1;
    if(k==="club_down_0_5") clubAdj-=0.5;
    if(k==="club_down_1") clubAdj-=1;
  }
  let ballScore=0; // + forward, - back
  if(tokens.includes("ball_forward")) ballScore+=1;
  if(tokens.includes("ball_back")) ballScore-=1;
  if(tokens.includes("ball_center_back")) ballScore-=0.5;

  let traj=0; // + high, - low
  if(tokens.includes("traj_low_1")) traj-=1;
  if(tokens.includes("traj_low_2")) traj-=2;
  if(tokens.includes("traj_high_1")) traj+=1;
  if(tokens.includes("traj_high_2")) traj+=2;
  traj += (ballScore>0? 0.5 : ballScore<0? -0.5 : 0);

  // remove raw club & raw traj flags before adding final
  const keep = tokens.filter(t => !/^club_(up|down)_/.test(t) && !/^traj_/.test(t));
  const finals=[];
  if(Math.abs(clubAdj)<0.25) finals.push("club_standard");
  else if(clubAdj>0) finals.push("club_up_1"); else finals.push("club_down_1");

  if(ballScore>0.25) finals.push("ball_forward");
  else if(ballScore<-0.25) finals.push("ball_back");
  else finals.push("ball_center");

  if(traj>=1) finals.push("traj_final_high");
  else if(traj<=-1) finals.push("traj_final_low");

  return { tokens:[...new Set(keep.concat(finals))], clubAdj, ballScore, traj };
}

function defaultWeight(token){
  const base={
    club_standard:1, take_enough_carry:3, full_commit:2,
    ball_center:1, ball_center_back:2, ball_forward:1, ball_back:2,
    widen_stance:1, weight_left:2, weight_uphill_foot:2, weight_forward:2, hands_forward:2,
    contact_ball_then_turf:2, normal_trajectory:1, steepen_slight:2, steepen:3, more_steep:2,
    shallow_angle:2, pick_ball:2, less_sand:2, splash_sand:3, accelerate:2, swing_smooth:1,
    short_back_long_through:2, shorter_back:2, commit_speed:3, flatter_plane:2, steeper_plane:2,
    bend_knees:1, bend_knees_more:2, grip_down_0_5:1, grip_down_1:2, firm_grip_lite:1, firm_grip:2,
    open_face:2, speed_pop:2, hold_loft:2, keep_spin_down:2, control_spin:2, start_against_wind:2,
    start_against_wind_l2r:2, start_against_wind_r2l:2, allow_drift:1, clip_ball:2, make_divot_en:2,
    consider_putt_or_low_chip:2, reduce_loft_hint:1, aim_left:1, aim_left_more:1, aim_right:1, aim_right_more:1, aim_balance:1,
    knockdown:3, land_before_flag:2, land_soft:2, aim_center_bias:1, tee_height_half:1, launch_high:1
  };
  return base[token]||1;
}

function renderAdvice(tokens, weights, summary){
  const mapText = t => {
    if(t==="traj_final_high") return "‡∏ß‡∏¥‡∏ñ‡∏µ‡∏™‡∏π‡∏á (‡∏ï‡∏Å‡∏ô‡∏∏‡πà‡∏°/‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏£‡πá‡∏ß)";
    if(t==="traj_final_low") return "‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ï‡πà‡∏≥ (‡∏Ñ‡∏∏‡∏°‡∏ó‡∏¥‡∏®/‡∏ó‡∏∞‡∏•‡∏∏‡∏•‡∏°)";
    return tokenText[t] || t;
  };
  const scored = tokens.map(t=>({t, score: defaultWeight(t) + ((weights&&Number.isFinite(weights[t]))?weights[t]:0), text: mapText(t)}))
                       .sort((a,b)=> b.score - a.score);
  const sections=[
    {name:"‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πâ/‡∏à‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞", test:x=>/^club_/.test(x.t) || ["take_enough_carry","full_commit"].includes(x.t)},
    {name:"‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏±‡∏û/‡∏¢‡∏∑‡∏ô‡∏à‡∏î‡∏•‡∏π‡∏Å", test:x=>/(^ball_)|(^weight_)|(^hands_)|(^widen_)|(^grip_)/.test(x.t)},
    {name:"‡∏Ñ‡∏µ‡∏¢‡πå‡∏™‡∏ß‡∏¥‡∏á/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞", test:x=>/(contact_|normal_|steepen|shallow_|pick_ball|less_sand|splash_sand|accelerate|swing_smooth|short_back|shorter_back|commit_speed|flatter_plane|steeper_plane|hold_loft|open_face|speed_pop|clip_ball|make_divot_en|consider_putt_or_low_chip|reduce_loft_hint)/.test(x.t)},
    {name:"‡∏ó‡∏¥‡∏®/‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° & ‡∏ß‡∏¥‡∏ñ‡∏µ/‡∏•‡∏á‡∏à‡∏≠‡∏î", test:x=>/(^aim_)|(^start_)|(^allow_)|(^traj_final_)|(^land_)/.test(x.t)}
  ];
  const html=[];
  if(summary){ html.push('<div class="small" style="padding:8px;border:1px solid #334155;border-radius:8px;margin-bottom:6px">'+summary+'</div>'); }
  for(const sec of sections){
    const items = scored.filter(sec.test).slice(0,8);
    if(items.length){
      html.push('‚Ä¢ <span class="small" style="color:#93c5fd">'+sec.name+'</span>');
      html.push('<ul>');
      for(const it of items){ html.push('<li>'+it.text+'</li>'); }
      html.push('</ul>');
    }
  }
  if(!html.length){
    html.push('<ul>');
    for(const it of scored.slice(0,10)){ html.push('<li>'+it.text+'</li>'); }
    html.push('</ul>');
  }
  const tags = scored.slice(0,8).map(it=>'<span class="tag">'+it.text+'</span>').join(' ');
  return { html: html.join('\n'), tags };
}

function netClubText(val){ const r=Math.round(val*2)/2; if(Math.abs(r)<0.25) return "‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥"; return (r>0? "+":"")+r+" ‡πÄ‡∏ö‡∏≠‡∏£‡πå"; }
function trajText(v){ return v>=1? "‡∏™‡∏π‡∏á" : v<=-1? "‡∏ï‡πà‡∏≥" : "‡∏Å‡∏•‡∏≤‡∏á"; }
function lineText(tokens){
  if(tokens.includes('aim_center_bias')) return '‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô (‡∏ó‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)';
  if(tokens.includes('start_against_wind_l2r')) return '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡πâ‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏•‡∏°‡∏û‡∏≤‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤';
  if(tokens.includes('start_against_wind_r2l')) return '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏ß‡∏≤ ‡πÉ‡∏´‡πâ‡∏•‡∏°‡∏û‡∏≤‡πÑ‡∏õ‡∏ã‡πâ‡∏≤‡∏¢';
  if(tokens.includes('aim_left_more')||tokens.includes('aim_left')) return '‡πÄ‡∏•‡πá‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢';
  if(tokens.includes('aim_right_more')||tokens.includes('aim_right')) return '‡πÄ‡∏•‡πá‡∏á‡∏Ç‡∏ß‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢';
  return '‡πÄ‡∏•‡πá‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
}
function applySafetyBias(state, tokens){
  const risky = state.obs!=="none" || state.stance==="unstable" || state.slopeY==="down_big" || state.slopeY==="up_big" || /‡∏´‡∏•‡∏∏‡∏°‡∏•‡∏∂‡∏Å|OB|‡∏ô‡πâ‡∏≥|‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå/.test(state.notes||'');
  if(risky){
    // Enforce center-aim safety without side bias; user will handle hazard-avoid aim manually
    tokens.add('aim_center_bias');
    // Strip any side-aim tokens to keep center aim
    ['aim_left','aim_left_more','aim_right','aim_right_more'].forEach(k=> tokens.delete(k));
    // Keep wind-start guidance and tempo/carry safety
    tokens.add('swing_smooth');
    tokens.add('take_enough_carry');
  }
}

let LAST=null, TOK=[];
function recommend(){
  const s=getState();
  const raw=gatherTokens(s);
  const resolved=resolveTokens(raw.tokens);
  const tset=new Set(resolved.tokens);
  applySafetyBias(s,tset);
  const finalTokens=[...tset];

  LAST=s; TOK=finalTokens;
  const summary = `‡∏™‡∏£‡∏∏‡∏õ: ‡πÑ‡∏°‡πâ ${netClubText(resolved.clubAdj)} ‚Ä¢ ‡∏ß‡∏¥‡∏ñ‡∏µ ${trajText(resolved.traj)} ‚Ä¢ ‡πÄ‡∏™‡πâ‡∏ô ${lineText(finalTokens)}`;
  const advice=renderAdvice(finalTokens, getWeights(), summary);
  document.getElementById('output').innerHTML=advice.html;
  document.getElementById('tags').innerHTML=advice.tags;
  document.getElementById('why').textContent = JSON.stringify({state:s, raw:raw, resolved, finalTokens, summary}, null, 2);
  document.getElementById('score').textContent = '‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå: ' + profScore();
  const logs=getLogs(); logs.push({type:'recommend', state:s, tokens:finalTokens, summary, ts:new Date().toISOString()}); setLogs(logs);
  window.scrollTo({top:0, behavior:'smooth'});
}

function feedback(good){
  if(!LAST){ alert('‡∏Å‡∏î "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏µ" ‡∏Å‡πà‡∏≠‡∏ô'); return; }
  const w=getWeights(); const delta = good? 1 : -1;
  for(const t of TOK){ w[t] = (w[t]||0) + delta; }
  setWeights(w);
  document.getElementById('score').textContent = '‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå: ' + profScore();
  const advice=renderAdvice(TOK, w);
  document.getElementById('output').innerHTML=advice.html;
  document.getElementById('tags').innerHTML=advice.tags;
  const logs=getLogs(); logs.push({type: good? 'good':'bad', state:LAST, tokens:TOK, delta, ts:new Date().toISOString()}); setLogs(logs);
}

function saveResult(){
  const logs=getLogs();
  logs.push({type:'result', res_main:document.getElementById('res_main').value, ball_shape:document.getElementById('ball_shape').value, miss_m:+document.getElementById('miss_m').value, state:LAST, ts:new Date().toISOString()});
  setLogs(logs); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß');
  document.getElementById('logCount').textContent='logs: '+logs.length;
}

function exportData(){ const data={version:'pro-2.4', weights:getWeights(), logs:getLogs()}; const url=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'})); const a=document.createElement('a'); a.href=url; a.download='golf_shot_profile.json'; a.click(); URL.revokeObjectURL(url); }
function importData(){ const i=document.createElement('input'); i.type='file'; i.accept='application/json'; i.onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const d=JSON.parse(r.result); if(d.weights) setWeights(d.weights); if(d.logs) setLogs(d.logs); alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); document.getElementById('score').textContent='‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå: '+profScore(); document.getElementById('logCount').textContent='logs: '+getLogs().length; }catch(err){ alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); } }; r.readAsText(f); }; i.click(); }
function clearData(){ if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){ localStorage.removeItem(KEY); localStorage.removeItem(LOG); document.getElementById('score').textContent='‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå: 0'; document.getElementById('logCount').textContent='logs: 0'; alert('‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß'); } }
function resetForm(){ for(const id of ['shotType','lie','slopeY','slopeX','wind','ball','turf','obs','stance','pin','green']) document.getElementById(id).selectedIndex=0; document.getElementById('dist').value=120; document.getElementById('notes').value=''; document.getElementById('output').textContent='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏µ‚Äù'; document.getElementById('tags').innerHTML=''; document.getElementById('why').textContent=''; }

// ==== Self Tests ====
function runTests(){
  const out=[]; const A=(n,c)=>({name:n,pass:!!c});
  // A: Fairway flat, calm
  let s={shotType:'approach', lie:'‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå', dist:120, slopeY:'flat', slopeX:'level', wind:'calm', ball:'normal', turf:'normal', obs:'none', stance:'stable', pin:'center', green:'normal', notes:'', time:new Date().toISOString()};
  let raw=gatherTokens(s); let rz=resolveTokens(raw.tokens); let tokens=new Set(rz.tokens); applySafetyBias(s,tokens);
  out.push(A('A1 club_standard', tokens.has('club_standard')));
  out.push(A('A2 contact_ball_then_turf', tokens.has('contact_ball_then_turf')));

  // B: Headwind big + uphill big ‚Üí net >= +1.5
  s={...s, wind:'head_big', slopeY:'up_big'}; raw=gatherTokens(s); rz=resolveTokens(raw.tokens);
  out.push(A('B1 net club >= +1.5', Math.round(rz.clubAdj*2)/2 >= 1.5));

  // C: Downhill big ‚Üí net down >= 0.5 and traj high/neutral
  s={...s, wind:'calm', slopeY:'down_big'}; raw=gatherTokens(s); rz=resolveTokens(raw.tokens);
  out.push(A('C1 net club <= -0.5', Math.round(rz.clubAdj*2)/2 <= -0.5));

  // D: Risky with obstacle ‚Üí aim_center_bias applied by safety policy
  s={...s, obs:'carry'}; raw=gatherTokens(s); rz=resolveTokens(raw.tokens); let t4=new Set(rz.tokens); applySafetyBias(s,t4);
  out.push(A('D1 safety aim_center_bias', t4.has('aim_center_bias')));

  // E: Side slope above_big ‚Üí expect aim_right_more
  s={...s, obs:'none', slopeY:'flat', slopeX:'above_big', wind:'calm'}; raw=gatherTokens(s); rz=resolveTokens(raw.tokens);
  out.push(A('E1 side slope aim_right_more', rz.tokens.includes('aim_right_more')));

  // F: Greenside bunker ‚Üí must include splash_sand & weight_left
  s={...s, lie:'‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô'}; raw=gatherTokens(s); rz=resolveTokens(raw.tokens);
  out.push(A('F1 splash_sand present', rz.tokens.includes('splash_sand')));
  out.push(A('F2 weight_left present', rz.tokens.includes('weight_left')));

  // G: Safety via notes (contains "OB") ‚Üí aim_center_bias added by policy
  s={...s, lie:'‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå', notes:'‡∏°‡∏µ OB ‡∏Ç‡∏ß‡∏≤‡∏•‡∏∂‡∏Å'}; raw=gatherTokens(s); rz=resolveTokens(raw.tokens); let tg=new Set(rz.tokens); applySafetyBias(s,tg);
  out.push(A('G1 policy from notes -> aim_center_bias', tg.has('aim_center_bias')));

  // H: API exposure ‚Üí recommend attached to window
  out.push(A('H1 window.recommend is function', typeof window.recommend === 'function'));

  // I: Safety strips side-aim tokens (user handles manual aim)
  s={shotType:'approach', lie:'‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå', dist:140, slopeY:'flat', slopeX:'below_big', wind:'calm', ball:'normal', turf:'normal', obs:'carry', stance:'stable', pin:'center', green:'normal', notes:'', time:new Date().toISOString()};
  raw=gatherTokens(s); rz=resolveTokens(raw.tokens); let ti=new Set(rz.tokens); // slopeX would add aim_left_more
  applySafetyBias(s,ti); // risky due to obs
  out.push(A('I1 safety removes side aim', !ti.has('aim_left') && !ti.has('aim_left_more') && !ti.has('aim_right') && !ti.has('aim_right_more')));
  out.push(A('I2 still has aim_center_bias', ti.has('aim_center_bias')));

  const lines = out.map(x=> (x.pass?'‚úÖ':'‚ùå')+' '+x.name);
  const fails = out.filter(x=>!x.pass);
  document.getElementById('testout').textContent = lines.join('\n')+'\n---\n'+(fails.length?('FAILED: '+fails.length):'ALL PASSED');
}

// expose to global
window.recommend = recommend;
window.feedback = feedback;
window.runTests = runTests;
window.resetForm = resetForm;

// Init
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('score').textContent='‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå: '+profScore();
  const logs=getLogs(); document.getElementById('logCount').textContent='logs: '+logs.length;
});
</script>
</body>
</html>
